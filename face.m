%% EXAMPLE: Differential drive vehicle following waypoints using the 
% Pure Pursuit algorithm
%
% Copyright 2018-2019 The MathWorks, Inc.

%% Define Vehicle
R = 0.1;                % Wheel radius [m]
L = 0.5;                % Wheelbase [m]
dd = DifferentialDrive(R,L);

%% Simulation parameters
sampleTime = 0.01;               % Sample time [s]
tVec = 0:sampleTime:100;         % Time array
    
initPose = [0.7325781092521696;6.6802198543991915;0];             % Initial pose (x y theta)
pose = zeros(3,numel(tVec));    % Pose matrix
pose(:,1) = initPose;

% Define waypoints
waypoints = [
    0.7325781092521696, 6.6802198543991915;
    0.2933268330184771, 7.097508566821199;
    0.4690273435119541, 7.976011119288583;
    1.0180914388040696, 9.359652639424715;
    1.8526688636480853, 10.260117755703783;
    2.928834490420632, 10.918994670054323;
    4.20266319149834, 10.984882361489376;
    5.410604201140995, 10.962919797677692;
    6.179293934549956, 10.721331595749161;
    6.882095976523864, 10.15030493664536;
    7.233496997510818, 9.403577767048084;
    7.760598528991249, 8.942363927002706;
    8.0, 8.0;
    8.375550315718419, 7.0755460030095145;
    7.826486220426303, 6.658257290587507;
    7.584898018497772, 7.119471130632884;
    7.3213472527575565, 8.15171162978206;
    6.7722831574654405, 9.0961018736845;
    6.223219062173325, 9.601240841353246;
    5.4325667649526785, 9.776941351846721;
    4.861540105848879, 9.798903915658407;
    4.400326265803502, 9.183952128931237;
    3.8951872981347555, 9.601240841353246;
    3.038647309479055, 9.667128532788299;
    2.4895832141869394, 9.513390586106507;
    1.8307062998364008, 9.403577767048084;
    1.5451929702845006, 8.76666341650923;
    1.2377170769209158, 8.15171162978206;
    1.0620165664274388, 7.295171641126361;
    1.0400540026157543, 6.548444471529083;
    1.4793052788494467, 6.3727439610356065;
    1.5012678426611314, 5.779754738120122;
    1.4793052788494467, 5.274615770451375;
    1.9185565550831392, 4.923214749464422;
    2.4236955227518857, 4.835364494217683;
    3.104535000914109, 4.835364494217683;
    3.873224734323071, 5.011065004711161;
    4.005000117193179, 5.647979355250015;
    3.8073370428880167, 6.262931141977184;
    2.8190216713622087, 6.416669088658976;
    2.1381821931999854, 6.416669088658976;
    2.3138827036934626, 6.087230631483706;
    2.577433469433678, 5.779754738120122;
    3.1923852561608475, 5.757792174308437;
    3.499861149524432, 6.021342940048653;
    2.884909362797263, 6.240968578165499;
    3.8073370428880167, 6.965733183951091;
    3.1923852561608475, 7.1633962582562525;
    2.643321160868732, 7.207321385879622;
    2.182107320823355, 7.207321385879622;
    1.7208934807779777, 6.943770620139406;
    1.8965939912714547, 6.592369599152453;
    2.4676206503752547, 6.702182418210876;
    2.994722181855686, 6.746107545834245;
    3.499861149524432, 6.833957801080984;
    4.2465883191217095, 6.3727439610356065;
    5.212941126835832, 6.438631652470661;
    5.805930349751318, 6.548444471529083;
    6.354994445043433, 6.592369599152453;
    6.882095976523864, 6.592369599152453;
    7.3213472527575565, 6.592369599152453;
    7.3213472527575565, 6.175080886730445;
    7.343309816569241, 5.713867046685068;
    7.233496997510818, 5.3405034618864295;
    7.013871359393971, 5.076952696146214;
    6.24518162598501, 5.011065004711161;
    5.652192403069525, 4.989102440899476;
    5.212941126835832, 5.208728079016322;
    4.993315488718986, 5.538166536191591;
    4.861540105848879, 6.021342940048653;
    5.38864163732931, 6.065268067672022;
    5.740042658316264, 6.2848937057888685;
    6.28910675360838, 6.219006014353814;
    6.311069317420064, 5.889567557178545;
    5.740042658316264, 5.801717301931807;
    4.510139084861925, 6.175080886730445;
    5.081165743965725, 7.3171342049380454;
    5.696117530692894, 7.4708721516198375;
    6.179293934549956, 7.448909587808153;
    6.684432902218703, 7.251246513502991;
    6.267144189796695, 7.031620875386145;
    5.783967785939633, 7.031620875386145;
    5.0372406163423555, 7.00965831157446;
    4.0, 4.0;
    4.6419144677320325, 3.649386048386714;
    5.344716509705941, 4.044712196997037;
    5.300791382082571, 4.527888600854099;
    4.971352924907301, 5.164802951392953;
    4.422288829615186, 5.867604993366861;
    3.873224734323071, 6.460594216282345;
    2.401732958940201, 6.328818833412237;
    1.7867811722130316, 6.416669088658976;
    1.0180914388040696, 6.526481907717399;
    0.9082786197456465, 5.823679865743491;
    0.9741663111807004, 5.011065004711161;
    1.1498668216741774, 4.286300398925568;
    1.3694924597910236, 3.5615357931399756;
    1.5451929702845006, 2.72695836829596;
    2.0, 2.0;
    2.335845267505147, 1.4311671034065678;
    2.884909362797263, 0.9699532633611909;
    3.4559360219010626, 0.508739423315814;
    4.466213957238556, 0.26715122138728326;
    5.652192403069525, 0.7064024976209755;
    6.5306949555369105, 1.255466592913091;
    6.003593424056479, 2.353594783497322;
    5.652192403069525, 2.858733751166068;
    5.05920318015404, 3.2320973359647063;
    4.597989340108663, 3.0563968254712295;
    4.180700627686655, 3.210134772153022;
    3.5877114047711705, 2.8148086235426986;
    4.136775500063286, 2.4853701663674297;
    4.751727286790455, 2.463407602555745;
    5.38864163732931, 2.8148086235426986;
    3.6755616600179093, 2.8806963149777527;
    5.520417020199417, 2.968546570224491;
    6.0, 2.0;
    6.684432902218703, 1.5190173586533064;
    7.057796487017341, 2.353594783497322;
    7.475085199439349, 3.0344342616595448;
    7.584898018497772, 3.8470491226918755;
    7.760598528991249, 4.6377014199125215;
    7.826486220426303, 5.538166536191591;
    8.0, 6.0];
% Create visualizer
viz = Visualizer2D;
viz.hasWaypoints = true;

%% Pure Pursuit Controller
controller = controllerPurePursuit;
controller.Waypoints = waypoints;
controller.LookaheadDistance = .1;
controller.DesiredLinearVelocity = 1;
controller.MaxAngularVelocity = 10;

%% Simulation loop
close all
r = rateControl(1/sampleTime);
for idx = 2:numel(tVec) 
    % Run the Pure Pursuit controller and convert output to wheel speeds
    [vRef,wRef] = controller(pose(:,idx-1));
    [wL,wR] = inverseKinematics(dd,vRef,wRef);
 
    
    % Compute the velocities
    [v,w] = forwardKinematics(dd,wL,wR);
    velB = [v;0;w]; % Body velocities [vx;vy;w]
    vel = bodyToWorld(velB,pose(:,idx-1));  % Convert from body to world
    
    % Perform forward discrete integration step
    pose(:,idx) = pose(:,idx-1) + vel*sampleTime; 
    
    % Update visualization
    viz(pose(:,idx),waypoints)
    waitfor(r);
    
end